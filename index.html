<!doctype html>
<meta charset="utf-8">
<title>ã„ã‚ãã‚ƒã‚‰ â†’ ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢è²¼ã‚Šä»˜ã‘ç”¨ JSON å¤‰æ›ï¼ˆå…¬é–‹ç‰ˆï¼‰</title>
<style>
  body{font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .sticky{position:sticky;top:0;z-index:10;background:#fff;padding:10px 0 6px;margin:0 0 10px;border-bottom:1px solid #e5e5e5}
  .title{font-size:18px;font-weight:700}
  .box{border:1px solid #ccc;border-radius:10px;padding:14px;margin:8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  textarea, input[type="text"]{width:100%;font-family:ui-monospace,Consolas,monospace;font-size:13px}
  textarea{height:220px}
  button{padding:8px 14px;border-radius:8px;border:1px solid #999;cursor:pointer;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px}
  th{background:#fafafa}
  .drag{cursor:grab;width:2rem;text-align:center}
  .ok{color:#0a7a20;font-weight:600}
  .err{color:#b00020;font-weight:600;white-space:pre-wrap}
  .small{color:#555;font-size:12px}
</style>

<div class="sticky">
  <div class="title">ã„ã‚ãã‚ƒã‚‰ â†’ ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢è²¼ã‚Šä»˜ã‘ç”¨ JSON å¤‰æ›ï¼ˆstatusä¸¦ã³æ›¿ãˆ/è¿½åŠ /å‰Šé™¤ãƒ»nameç·¨é›†ï¼‹SAN=POWÃ—5ï¼‰</div>
  <div class="small">
    1) JSONè²¼ã‚Šä»˜ã‘ â†’ <b>è§£æï¼ˆstatusè¡¨ç¤ºï¼‰</b>ï¼ˆã“ã“ã§ SAN ã« POWÃ—5 ã‚’è‡ªå‹•åæ˜ ï¼‰â†’ ä¸¦ã³æ›¿ãˆ/è¿½åŠ /å‰Šé™¤/ç·¨é›†ãƒ»nameç·¨é›† â†’
    2) <b>â–¶ å®Ÿè¡Œ</b>ï¼ˆcommands æ›¸æ›ï¼†paramsè¿½è¨˜ï¼‰ â†’ 3) <b>ğŸ“‹ ã‚³ãƒ”ãƒ¼</b>
  </div>
</div>

<div class="box">
  <div class="row">
    <div style="flex:1;min-width:320px">
      <label><b>ã„ã‚ãã‚ƒã‚‰JSONï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</b></label>
      <textarea id="input" placeholder="ã„ã‚ãã‚ƒã‚‰ã§ã‚³ãƒ”ãƒ¼ã—ãŸJSONã‚’è²¼ã‚Šä»˜ã‘"></textarea>
    </div>
    <div style="flex:1;min-width:320px">
      <label><b>å¤‰æ›çµæœï¼ˆã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘å¯ï¼‰</b></label>
      <textarea id="output" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
    </div>
  </div>

  <div class="row">
    <button id="parseBtn">è§£æï¼ˆstatusè¡¨ç¤ºï¼‰</button>
    <button id="runBtn">â–¶ å®Ÿè¡Œ</button>
    <button id="copyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    <span id="msg" class="small"></span>
  </div>

  <div id="metaBox" style="display:none;margin-top:8px">
    <label><b>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼ˆnameï¼‰</b></label>
    <input id="nameInput" type="text" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å">
  </div>

  <div id="statusBox" class="small" style="display:none;margin-top:8px">
    <b>status ä¸¦ã³æ›¿ãˆãƒ»ç·¨é›†ãƒ»è¿½åŠ /å‰Šé™¤</b>
    <div class="small">è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆå¯èƒ½ã€‚å€¤ã¯ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚</div>
    <table id="statusTable">
      <thead>
        <tr>
          <th style="width:2rem">â†•</th>
          <th>ãƒ©ãƒ™ãƒ«</th>
          <th style="width:8rem">å€¤ (value)</th>
          <th style="width:8rem">æœ€å¤§ (max)</th>
          <th style="width:6rem">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="addRowBtn" style="margin-top:8px">ï¼‹ è¡Œã‚’è¿½åŠ </button>
  </div>

  <div id="error" class="err"></div>
</div>

<script>
let _obj=null;

// æ”¹è¡Œè£œæ­£ã—ã¦ JSON.parse
function fixJSONNewlines(s){
  let out="",inStr=false,esc=false;
  for(let i=0;i<s.length;i++){
    const ch=s[i];
    if(!inStr){
      if(ch==='"'){inStr=true;out+=ch;esc=false;}
      else out+=ch;
    }else{
      if(esc){out+=ch;esc=false;continue;}
      if(ch==="\\"){out+=ch;esc=true;continue;}
      if(ch==='"'){inStr=false;out+=ch;continue;}
      if(ch==="\n"){out+="\\n";continue;}
      if(ch==="\r"){if(i+1<s.length&&s[i+1]==="\n"){i++;}out+="\\n";continue;}
      out+=ch;
    }
  }
  return out;
}
function safeParse(jsonText){
  try{ return JSON.parse(jsonText); }
  catch(e){ return JSON.parse(fixJSONNewlines(jsonText)); }
}

// ãƒãƒƒãƒ—åŒ–
function buildParamMap(data){
  const m={}; (data.params||[]).forEach(p=>{ if(p&&p.label!=null&&p.value!=null){ m[String(p.label).trim().toUpperCase()]=String(p.value).trim(); }});
  return m;
}
function buildStatusMap(data){
  const m={}; (data.status||[]).forEach(s=>{ if(s&&s.label!=null&&s.value!=null){ m[String(s.label).trim().toUpperCase()]=s.value; }});
  return m;
}

// commandsæŠ½å‡º
const RE_FIXED_ANYWHERE = /CCB<=\s*(\d+)\s*ã€([^ã€‘]+)ã€‘/g;
const RE_FORM_ANYWHERE  = /CCB<=\s*\{\s*([A-Za-z]+)\s*\}\s*\*\s*(\d+)\s*ã€([^ã€‘]+)ã€‘/g;
function extractPairsAll(commands){
  const pairs=[]; let m;
  while((m=RE_FIXED_ANYWHERE.exec(commands))){ pairs.push({label:m[2].trim(), token:m[1]}); }
  while((m=RE_FORM_ANYWHERE.exec(commands))){ pairs.push({label:m[3].trim(), token:`{${m[1].trim().toUpperCase()}}*${m[2].trim()}`}); }
  return pairs;
}
function evaluateToken(tok, params, status){
  tok=String(tok).trim();
  if(/^\d+$/.test(tok)) return tok;
  const m=tok.match(/^\{\s*([A-Za-z]+)\s*\}\s*\*\s*(\d+)$/);
  if(m){
    const varName=m[1].toUpperCase(); const k=parseInt(m[2],10);
    let base=null;
    if(params[varName] && /^\-?\d+$/.test(params[varName])) base=parseInt(params[varName],10);
    else if(status[varName]!=null && !isNaN(Number(status[varName]))) base=parseInt(status[varName],10);
    if(base!=null) return String(base*k);
    return tok;
  }
  return tok;
}

// å›ºå®šå€¤è¡Œã‚’ã€Œ{æŠ€èƒ½} ã€ˆæŠ€èƒ½ã€‰ã€ã¸ç½®æ›
const RE_FIXED_LINE = /^(CCB<=)\s*(\d+)\s*ã€([^ã€‘]+)ã€‘\s*$/;
function rewriteCommands(commands){
  const lines=commands.split(/\r?\n/);
  const ideographicSpace="ã€€"; // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
  return lines.map(line=>{
    const m=line.match(RE_FIXED_LINE);
    if(m){
      const label=m[3].trim();
      return `CCB<={${label}}${ideographicSpace}  ã€ˆ${label}ã€‰`;
    }
    return line;
  }).join("\n");
}

// å¤‰æ›ãƒ¡ã‚¤ãƒ³
function convertToClipboard(obj){
  const data=obj.data?obj.data:obj;
  let commands=data.commands||"";
  if(commands.includes("\\n") && !commands.includes("\n")){
    commands=commands.replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n");
  }
  const params=buildParamMap(data);
  const status=buildStatusMap(data);
  const pairs=extractPairsAll(commands);

  // commands æ›¸æ›
  commands=rewriteCommands(commands);

  // params è¿½è¨˜
  const existing=new Set((data.params||[]).map(p=>String(p.label||"").trim()));
  const add=[];
  pairs.forEach(({label,token})=>{
    const val=evaluateToken(token,params,status);
    if(label && !existing.has(label)){
      add.push({label,value:val});
      existing.add(label);
    }
  });
  data.params=(data.params||[]).concat(add);
  data.commands=commands;

  return {kind:"character",data};
}

// status ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
function renderStatusTable(list){
  const tbody=document.querySelector("#statusTable tbody");
  tbody.innerHTML="";
  list.forEach((st)=> tbody.appendChild(buildRow(st)));
  // DnD
  tbody.addEventListener("dragover", e=>{
    e.preventDefault();
    const dragging=tbody.querySelector("tr.dragging");
    const after=getDragAfterElement(tbody, e.clientY);
    if(!dragging) return;
    if(after==null) tbody.appendChild(dragging);
    else tbody.insertBefore(dragging, after);
  });
}
function buildRow(st){
  const tr=document.createElement("tr");
  tr.draggable=true;
  tr.innerHTML=`
    <td class="drag" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ">â†•</td>
    <td><input value="${st.label ?? ""}" data-role="label" style="width:100%"></td>
    <td><input value="${st.value ?? 0}" data-role="value" style="width:100%"></td>
    <td><input value="${st.max ?? 0}" data-role="max" style="width:100%"></td>
    <td><button data-role="del" style="padding:4px 8px">å‰Šé™¤</button></td>
  `;
  tr.addEventListener("dragstart", e=>{ tr.classList.add("dragging"); e.dataTransfer.effectAllowed="move"; });
  tr.addEventListener("dragend",   ()=> tr.classList.remove("dragging"));
  tr.querySelector('[data-role="del"]').onclick=()=> tr.remove();
  return tr;
}
function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll("tr:not(.dragging)")];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y - box.top - box.height/2;
    if(offset<0 && offset>closest.offset) return {offset, element:child};
    else return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}
function readStatusTable(){
  const rows=[...document.querySelectorAll("#statusTable tbody tr")];
  return rows.map(tr=>{
    const label=tr.querySelector('input[data-role="label"]').value.trim();
    const value=parseInt(tr.querySelector('input[data-role="value"]').value,10) || 0;
    const max=parseInt(tr.querySelector('input[data-role="max"]').value,10) || 0;
    return {label,value,max};
  });
}

// UI å–å¾—
const inputEl=document.getElementById("input");
const outputEl=document.getElementById("output");
const msgEl=document.getElementById("msg");
const errEl=document.getElementById("error");
const statusBox=document.getElementById("statusBox");
const metaBox=document.getElementById("metaBox");
const nameInput=document.getElementById("nameInput");
const parseBtn=document.getElementById("parseBtn");
const runBtn=document.getElementById("runBtn");
const copyBtn=document.getElementById("copyBtn");
const addRowBtn=document.getElementById("addRowBtn");

// è§£æï¼ˆstatusè¡¨ç¤ºï¼‰ï¼‹ SAN=POWÃ—5
parseBtn.onclick=()=>{
  errEl.textContent=""; msgEl.textContent=""; outputEl.value="";
  try{
    const raw=inputEl.value.trim();
    if(!raw){ errEl.textContent="JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„ã€‚"; return; }
    let obj=safeParse(raw);
    if(!("kind" in obj)) obj={kind:"character", data:obj};
    if(obj.kind!=="character") obj={kind:"character", data:obj.data||obj};
    _obj=obj;

    const data=_obj.data;
    nameInput.value = data.name ?? "";
    metaBox.style.display="block";

    if(data.commands && data.commands.includes("\\n") && !data.commands.includes("\n")){
      data.commands=data.commands.replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n");
    }

    // SAN=POWÃ—5 è‡ªå‹•åæ˜ ï¼ˆSANãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    const paramsMap = buildParamMap(data);
    const powRaw = paramsMap["POW"];
    const pow = powRaw!=null && /^\-?\d+$/.test(powRaw) ? parseInt(powRaw,10) : null;
    if (Array.isArray(data.status) && pow!==null){
      const sanIdx = data.status.findIndex(s => String(s.label||"").trim().toUpperCase()==="SAN");
      if (sanIdx >= 0){
        const sanVal = pow * 5;
        data.status[sanIdx].value = sanVal;
        data.status[sanIdx].max   = sanVal;
      }
    }

    renderStatusTable(Array.isArray(data.status)? data.status : []);
    statusBox.style.display="block";
    msgEl.textContent="status ã‚’ä¸¦ã³æ›¿ãˆï¼è¿½åŠ ï¼å‰Šé™¤ï¼ç·¨é›†ã—ã€name ã‚’å¿…è¦ãªã‚‰å¤‰æ›´ã—ã¦ã‹ã‚‰ â–¶ å®Ÿè¡Œã€‚";
    msgEl.className="ok small";
  }catch(e){
    errEl.textContent="è§£æã‚¨ãƒ©ãƒ¼:\n"+(e&&e.message?e.message:String(e));
  }
};

addRowBtn.onclick=()=>{
  const tbody=document.querySelector("#statusTable tbody");
  tbody.appendChild(buildRow({label:"",value:0,max:0}));
};

runBtn.onclick=()=>{
  errEl.textContent="";
  if(!_obj){ errEl.textContent="å…ˆã«ã€è§£æï¼ˆstatusè¡¨ç¤ºï¼‰ã€ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚"; return; }
  try{
    _obj.data.name = nameInput.value;
    _obj.data.status = readStatusTable();
    const out=convertToClipboard(_obj);
    outputEl.value=JSON.stringify(out);
    msgEl.textContent="å¤‰æ›å®Œäº†ã€‚ğŸ“‹ ã‚³ãƒ”ãƒ¼ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸é€ã‚Œã¾ã™ã€‚";
    msgEl.className="ok small";
  }catch(e){
    errEl.textContent="å¤‰æ›ã‚¨ãƒ©ãƒ¼:\n"+(e&&e.message?e.message:String(e));
  }
};

copyBtn.onclick=async ()=>{
  errEl.textContent="";
  const text=outputEl.value.trim();
  if(!text){ errEl.textContent="å‡ºåŠ›ãŒç©ºã§ã™ã€‚å…ˆã« â–¶ å®Ÿè¡Œ ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚"; return; }
  try{
    await navigator.clipboard.writeText(text);
    msgEl.textContent="ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ä¸Šã§ Ctrl+V ã—ã¦ãã ã•ã„ã€‚";
    msgEl.className="ok small";
  }catch(e){
    errEl.textContent="ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å‡ºåŠ›æ¬„ã‚’å…¨é¸æŠã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚";
  }
};
</script>
</body>
</html>
